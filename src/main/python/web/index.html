<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸福氣管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            transform: translateX(2px);
        }
        
        /* Client Detail Modal Tabs */
        .client-tab-btn {
            transition: all 0.2s ease;
        }
        .client-tab-btn:not(.active):hover {
            color: #4B5563;
            border-color: #D1D5DB;
        }
        .client-tab-content {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Delivery table hover effect */
        .delivery-row:hover {
            background-color: #F9FAFB;
            cursor: pointer;
        }
        
        /* Modal animations */
        .fixed {
            animation: modalFadeIn 0.2s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Delivery tabs styling */
        .delivery-tab {
            position: relative;
        }
        .delivery-tab:not(.bg-white):hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .delivery-tab.bg-white {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-fire-flame-curved text-2xl"></i>
                    <h1 class="text-xl font-bold">幸福氣管理系統</h1>
                </div>
                <div class="flex space-x-6">
                    <a href="#dashboard" class="nav-link hover:text-blue-200 transition font-bold text-blue-200">
                        <i class="fas fa-chart-line mr-1"></i>儀表板
                    </a>
                    <a href="#clients" class="nav-link hover:text-blue-200 transition">
                        <i class="fas fa-users mr-1"></i>客戶管理
                    </a>
                    <a href="#drivers" class="nav-link hover:text-blue-200 transition">
                        <i class="fas fa-id-card mr-1"></i>司機管理
                    </a>
                    <a href="#vehicles" class="nav-link hover:text-blue-200 transition">
                        <i class="fas fa-truck mr-1"></i>車輛管理
                    </a>
                    <a href="#deliveries" class="nav-link hover:text-blue-200 transition">
                        <i class="fas fa-shipping-fast mr-1"></i>配送管理
                    </a>
                    <a href="#routes" class="nav-link hover:text-blue-200 transition">
                        <i class="fas fa-route mr-1"></i>路線規劃
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="currentDate" class="text-sm"></span>
                    <button class="hover:text-blue-200" title="登出">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Dashboard Section -->
        <section id="dashboard" class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">儀表板</h2>
                <button onclick="refreshStats()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    <i class="fas fa-sync"></i> 重新整理
                </button>
            </div>
            
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">總客戶數</p>
                            <p class="text-2xl font-bold text-blue-600" id="total-clients">-</p>
                        </div>
                        <i class="fas fa-users text-3xl text-blue-500 opacity-50"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">今日配送</p>
                            <p class="text-2xl font-bold text-green-600" id="today-deliveries">-</p>
                        </div>
                        <i class="fas fa-truck text-3xl text-green-500 opacity-50"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">可用司機</p>
                            <p class="text-2xl font-bold text-purple-600" id="available-drivers">-</p>
                        </div>
                        <i class="fas fa-id-card text-3xl text-purple-500 opacity-50"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">可用車輛</p>
                            <p class="text-2xl font-bold text-orange-600" id="available-vehicles">-</p>
                        </div>
                        <i class="fas fa-car text-3xl text-orange-500 opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- Charts and Activities -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">本週配送統計</h3>
                    <canvas id="deliveryChart"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">配送狀態分布</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6" id="recent-activities">
                    <h3 class="text-lg font-semibold mb-4">最近活動</h3>
                    <div class="text-gray-500 text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section id="clients" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">客戶管理</h2>
                <div class="flex gap-2">
                    <button onclick="exportClients()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-download mr-2"></i>匯出
                    </button>
                    <button onclick="showAddClientModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>新增客戶
                    </button>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <input type="text" id="client-search" placeholder="搜尋客戶名稱、地址或客戶編號..." 
                               class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <select id="client-district" class="px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                        <option value="">所有區域</option>
                    </select>
                    <select id="client-status" class="px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                        <option value="">所有狀態</option>
                        <option value="true">啟用</option>
                        <option value="false">停用</option>
                    </select>
                </div>
            </div>
            
            <!-- Clients Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortClients('id')">
                                客戶編號 <i class="fas fa-sort text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客戶資訊</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地址</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">區域</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortClients('total_orders')">
                                訂單數 <i class="fas fa-sort text-gray-400"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="clients-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Client rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div class="text-sm text-gray-600">
                    顯示 <span id="clients-showing">0</span> 筆資料，共 <span id="clients-total">0</span> 筆
                </div>
                <div class="flex gap-2" id="clients-pagination">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Drivers Section -->
        <section id="drivers" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">司機管理</h2>
                <button onclick="showAddDriverModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>新增司機
                </button>
            </div>
            
            <!-- Driver Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">總司機數</p>
                    <p class="text-xl font-bold" id="total-drivers">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">可用司機</p>
                    <p class="text-xl font-bold text-green-600" id="available-drivers-count">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">配送中</p>
                    <p class="text-xl font-bold text-blue-600" id="busy-drivers">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">今日完成</p>
                    <p class="text-xl font-bold text-purple-600" id="today-completed-drivers">0</p>
                </div>
            </div>
            
            <!-- Drivers Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">員工編號</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">電話</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">駕照類型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">今日配送</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Driver rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Vehicles Section -->
        <section id="vehicles" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">車輛管理</h2>
                <button onclick="showAddVehicleModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>新增車輛
                </button>
            </div>
            
            <!-- Vehicle Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">總車輛數</p>
                    <p class="text-xl font-bold" id="total-vehicles">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">可用車輛</p>
                    <p class="text-xl font-bold text-green-600" id="available-vehicles-count">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">維修中</p>
                    <p class="text-xl font-bold text-orange-600" id="maintenance-vehicles">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <p class="text-sm text-gray-600">需保養</p>
                    <p class="text-xl font-bold text-red-600" id="due-maintenance">0</p>
                </div>
            </div>
            
            <!-- Vehicles Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車牌號碼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品牌/型號</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">載重量</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">下次保養</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="vehicles-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Vehicle rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Deliveries Section -->
        <section id="deliveries" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold">配送管理</h2>
                    <!-- Tab Navigation -->
                    <div class="flex bg-gray-200 rounded-lg p-1">
                        <button id="tab-planned" onclick="switchDeliveryTab('planned')" 
                                class="delivery-tab px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-white text-blue-600 shadow">
                            <i class="fas fa-clock mr-1"></i>計劃中
                        </button>
                        <button id="tab-history" onclick="switchDeliveryTab('history')" 
                                class="delivery-tab px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-800">
                            <i class="fas fa-history mr-1"></i>歷史記錄
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportDeliveries()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-download mr-2"></i>匯出報表
                    </button>
                    <button onclick="showAddDeliveryModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>新增配送單
                    </button>
                </div>
            </div>
            
            <!-- Delivery Summary -->
            <div id="delivery-summary"></div>
            
            <!-- Delivery Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input type="date" id="delivery-date-from" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" id="delivery-date-to" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                        <select id="delivery-status" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">所有狀態</option>
                            <option value="pending">待處理</option>
                            <option value="assigned">已指派</option>
                            <option value="in_progress">配送中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">司機</label>
                        <select id="delivery-driver" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">所有司機</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">排序方式</label>
                        <select id="delivery-sort" onchange="sortDeliveries(this.value)" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="scheduled_date-desc">配送日期 (新到舊)</option>
                            <option value="scheduled_date-asc">配送日期 (舊到新)</option>
                            <option value="created_at-desc">建立時間 (新到舊)</option>
                            <option value="status-asc">狀態</option>
                            <option value="total_amount-desc">金額 (高到低)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Deliveries Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂單編號</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">客戶</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">配送地址</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預定時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">數量/金額</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">司機</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="deliveries-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Delivery rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div class="text-sm text-gray-600">
                    顯示 <span id="deliveries-showing">0</span> 筆資料，共 <span id="deliveries-total">0</span> 筆
                </div>
                <div class="flex gap-2" id="deliveries-pagination">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Routes Section -->
        <section id="routes" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">路線規劃</h2>
                <div class="flex gap-2">
                    <button onclick="showRoutePlanModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-magic mr-2"></i>自動規劃
                    </button>
                    <button onclick="showSchedulingModal()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
                        <i class="fas fa-calendar-alt mr-2"></i>進階排程
                    </button>
                    <button onclick="showAddRouteModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>手動建立
                    </button>
                </div>
            </div>
            
            <!-- Route Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input type="date" id="route-date-from" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" id="route-date-to" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">區域</label>
                        <select id="route-area" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">所有區域</option>
                            <option value="A-瑞光">A-瑞光</option>
                            <option value="B-四維">B-四維</option>
                            <option value="C-復國">C-復國</option>
                            <option value="D-泰東">D-泰東</option>
                            <option value="E-寶桑">E-寶桑</option>
                            <option value="F-成功線">F-成功線</option>
                            <option value="G-南迴線">G-南迴線</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">司機</label>
                        <select id="route-driver" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">所有司機</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="filterRoutes()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-filter mr-2"></i>篩選
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Routes Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                日期
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                路線名稱
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                區域
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                司機
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                車輛
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                客戶數
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                總距離
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                狀態
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                操作
                            </th>
                        </tr>
                    </thead>
                    <tbody id="routes-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Routes will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <div class="text-sm text-gray-600">
                    顯示 <span id="routes-showing">0</span> 筆資料，共 <span id="routes-total">0</span> 筆
                </div>
                <div class="flex gap-2" id="routes-pagination">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Modals (same as before, include all modals from original file) -->
    <!-- Add Client Modal -->
    <div id="addClientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">新增客戶</h3>
            <form id="add-client-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">客戶名稱</label>
                    <input type="text" name="name" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">客戶編號</label>
                    <input type="text" name="client_code" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">發票抬頭</label>
                    <input type="text" name="invoice_title" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                    <input type="text" name="address" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">聯絡人</label>
                    <input type="text" name="contact_person" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">統一編號</label>
                    <input type="text" name="tax_id" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <input type="checkbox" name="is_corporate" class="mr-2">
                        公司戶
                    </label>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('addClientModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        新增
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Delivery Modal -->
    <div id="addDeliveryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center overflow-y-auto z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full my-8">
            <h3 class="text-xl font-bold mb-4">新增配送單</h3>
            <form id="add-delivery-form">
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4 col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">客戶</label>
                        <select name="client_id" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇客戶</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">預定配送日期</label>
                        <input type="date" name="scheduled_date" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">預定時段</label>
                        <select name="scheduled_time_slot" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇</option>
                            <option value="上午 9:00-12:00">上午 9:00-12:00</option>
                            <option value="下午 12:00-15:00">下午 12:00-15:00</option>
                            <option value="下午 15:00-18:00">下午 15:00-18:00</option>
                            <option value="晚上 18:00-21:00">晚上 18:00-21:00</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">瓦斯桶數</label>
                        <input type="number" name="gas_quantity" required min="1" value="1" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">單價</label>
                        <input type="number" name="unit_price" required min="0" value="800" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">運費</label>
                        <input type="number" name="delivery_fee" min="0" value="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
                        <select name="payment_method" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="cash">現金</option>
                            <option value="transfer">轉帳</option>
                            <option value="monthly_billing">月結</option>
                        </select>
                    </div>
                    <div class="mb-4 col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">配送地址</label>
                        <input type="text" name="delivery_address" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">配送區域</label>
                        <input type="text" name="delivery_district" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">回收空桶數</label>
                        <input type="number" name="empty_cylinders_to_return" min="0" value="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4 col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                        <textarea name="notes" rows="3" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500"></textarea>
                    </div>
                    <div class="mb-4 col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <input type="checkbox" name="requires_empty_cylinder_return" class="mr-2">
                            需要回收空桶
                        </label>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('addDeliveryModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        新增
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Driver Modal -->
    <div id="addDriverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center overflow-y-auto z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full my-8">
            <h3 class="text-xl font-bold mb-4">新增司機</h3>
            <form id="add-driver-form">
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" name="name" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">員工編號</label>
                        <input type="text" name="employee_id" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">電話</label>
                        <input type="tel" name="phone" required pattern="09[0-9]{8}" placeholder="0912345678" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">身分證字號</label>
                        <input type="text" name="id_number" required pattern="[A-Z][0-9]{9}" placeholder="A123456789" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4 col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">地址</label>
                        <input type="text" name="address" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">緊急聯絡人</label>
                        <input type="text" name="emergency_contact" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">緊急聯絡電話</label>
                        <input type="tel" name="emergency_phone" required pattern="09[0-9]{8}" placeholder="0987654321" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">駕照號碼</label>
                        <input type="text" name="license_number" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">駕照類型</label>
                        <select name="license_type" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇</option>
                            <option value="職業大貨車">職業大貨車</option>
                            <option value="職業小型車">職業小型車</option>
                            <option value="普通大貨車">普通大貨車</option>
                            <option value="普通小型車">普通小型車</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">駕照到期日</label>
                        <input type="date" name="license_expiry_date" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">入職日期</label>
                        <input type="date" name="hire_date" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">底薪</label>
                        <input type="number" name="base_salary" required min="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">獎金比例 (%)</label>
                        <input type="number" name="commission_rate" required min="0" max="100" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('addDriverModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        新增
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="addVehicleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center overflow-y-auto z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full my-8">
            <h3 class="text-xl font-bold mb-4">新增車輛</h3>
            <form id="add-vehicle-form">
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">車牌號碼</label>
                        <input type="text" name="plate_number" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">車型</label>
                        <select name="vehicle_type" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇</option>
                            <option value="truck">貨車</option>
                            <option value="van">廂型車</option>
                            <option value="motorcycle">機車</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">品牌</label>
                        <input type="text" name="brand" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">型號</label>
                        <input type="text" name="model" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">出廠年份</label>
                        <input type="number" name="year" required min="1990" max="2030" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">燃料類型</label>
                        <select name="fuel_type" required class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇</option>
                            <option value="gasoline">汽油</option>
                            <option value="diesel">柴油</option>
                            <option value="electric">電動</option>
                            <option value="hybrid">油電混合</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大載重 (公斤)</label>
                        <input type="number" name="max_load_kg" required min="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大瓦斯桶數</label>
                        <input type="number" name="max_cylinders" required min="0" class="w-full px-4 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeModal('addVehicleModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        新增
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Configuration files - Must load before app.js -->
    <script src="config/config.js"></script>
    <script src="config/constants.js"></script>
    
    <script src="/utils/validation.js"></script>
    <script src="/utils/sanitization.js"></script>
    <script src="/js/utils/chartUtils.js"></script>
    <!-- Initialize global state before modules -->
    <script>
        // Initialize filters that modules depend on
        window.clientFilters = {
            keyword: '',
            district: '',
            isActive: '',
            sortBy: 'created_at',
            sortOrder: 'desc'
        };
        
        window.deliveryFilters = {
            dateFrom: '',
            dateTo: '',
            status: '',
            driverId: '',
            clientId: '',
            sortBy: 'scheduled_date',
            sortOrder: 'desc'
        };
        
        // Initialize other global variables
        window.currentClientPage = 1;
        window.currentDeliveryPage = 1;
        window.allClients = [];
        window.allDeliveries = [];
        window.allDrivers = [];
        window.allVehicles = [];
        
        // Initialize SecurityUtils for modules that need it
        window.SecurityUtils = {
            escapeHtml: function(text) {
                if (text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            },
            
            createTextNode: function(text) {
                return document.createTextNode(String(text || ''));
            },
            
            createElement: function(tag, attributes = {}, children = []) {
                const element = document.createElement(tag);
                
                Object.entries(attributes).forEach(([key, value]) => {
                    if (key === 'className') {
                        element.className = value;
                    } else if (key === 'id') {
                        element.id = value;
                    } else if (key.startsWith('data-')) {
                        element.setAttribute(key, value);
                    } else if (key === 'onclick' && typeof value === 'function') {
                        element.addEventListener('click', value);
                    } else if (key === 'title') {
                        element.title = value;
                    } else {
                        element.setAttribute(key, String(value));
                    }
                });
                
                children.forEach(child => {
                    if (typeof child === 'string') {
                        element.appendChild(this.createTextNode(child));
                    } else if (child instanceof Node) {
                        element.appendChild(child);
                    }
                });
                
                return element;
            }
        };
    </script>
    
    <!-- Module Loader - Must load before app.js -->
    <script src="/js/modules/module-loader.js?v=2"></script>
    <!-- App Utilities - Must load before app.js -->
    <script src="/static/app-utilities.js"></script>
    <script src="/static/app.js?v=9"></script>
    <script>
        // Initialize navigation when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            
            // Wait for modules to be loaded before setting up navigation
            function setupNavigation() {
                console.log('Setting up navigation...');
                console.log('window.loadClients available:', typeof window.loadClients);
                
                // Set up navigation links
                const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        const section = href.substring(1);
                        window.location.hash = section;
                        
                        // Hide all sections
                        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                        
                        // Show selected section
                        const sectionElement = document.getElementById(section);
                        if (sectionElement) {
                            sectionElement.classList.remove('hidden');
                            
                            // Update active nav
                            navLinks.forEach(navLink => {
                                navLink.classList.remove('text-blue-200', 'font-bold');
                                if (navLink.getAttribute('href') === `#${section}`) {
                                    navLink.classList.add('text-blue-200', 'font-bold');
                                }
                            });
                            
                            // Load section data
                            switch(section) {
                                case 'dashboard':
                                    if (typeof loadDashboard === 'function') loadDashboard();
                                    break;
                                case 'clients':
                                    if (typeof window.loadClients === 'function') window.loadClients();
                                    break;
                                case 'drivers':
                                    if (typeof window.loadDrivers === 'function') window.loadDrivers();
                                    break;
                                case 'vehicles':
                                    if (typeof window.loadVehicles === 'function') window.loadVehicles();
                                    break;
                                case 'deliveries':
                                    if (typeof window.loadDeliveries === 'function') window.loadDeliveries();
                                    break;
                                case 'routes':
                                    if (typeof loadRoutes === 'function') loadRoutes();
                                    break;
                            }
                        }
                    }
                });
            });
            
                // Handle initial hash or default to dashboard
                const initialHash = window.location.hash;
                if (initialHash && initialHash.length > 1) {
                    const section = initialHash.substring(1);
                    const link = document.querySelector(`a[href="#${section}"]`);
                    if (link) link.click();
                } else {
                    // No hash, default to dashboard
                    const dashboardLink = document.querySelector('a[href="#dashboard"]');
                    if (dashboardLink) dashboardLink.click();
                }
            }
            
            // Check if modules are already loaded
            if (window.LuckyGasModules && window.LuckyGasModules['client-handlers.js']) {
                console.log('Modules already loaded, setting up navigation immediately');
                setupNavigation();
            } else {
                console.log('Waiting for modules to load...');
                // Wait for modules to be loaded
                window.addEventListener('modulesLoaded', function() {
                    console.log('Modules loaded event received');
                    setupNavigation();
                    
                    // Set up event delegation for dynamic buttons
                    if (window.eventDelegation && window.eventDelegation.init) {
                        window.eventDelegation.init();
                        console.log('Event delegation initialized');
                    }
                });
            }
        });
        
        // Dashboard functions
        async function loadDashboard() {
            try {
                // Use the API endpoint directly since API_BASE might not be defined yet
                const response = await fetch('/api/dashboard/stats');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const stats = await response.json();
                
                // Update dashboard stats with correct field mappings
                document.getElementById('total-clients').textContent = stats.overview?.total_clients || 0;
                document.getElementById('today-deliveries').textContent = stats.today_deliveries?.total || 0;
                document.getElementById('available-drivers').textContent = stats.overview?.available_drivers || 0;
                document.getElementById('available-vehicles').textContent = stats.overview?.available_vehicles || 0;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Show error state
                document.getElementById('total-clients').textContent = 'Error';
                document.getElementById('today-deliveries').textContent = 'Error';
                document.getElementById('available-drivers').textContent = 'Error';
                document.getElementById('available-vehicles').textContent = 'Error';
            }
        }
        
        // Refresh dashboard stats
        function refreshStats() {
            loadDashboard();
        }
        
        // Additional enhanced functions
        function sortClients(field) {
            if (window.clientFilters.sortBy === field) {
                window.clientFilters.sortOrder = window.clientFilters.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                window.clientFilters.sortBy = field;
                window.clientFilters.sortOrder = 'desc';
            }
            window.loadClients(1);
        }
        
        function sortDeliveries(value) {
            const [field, order] = value.split('-');
            window.deliveryFilters.sortBy = field;
            window.deliveryFilters.sortOrder = order;
            window.loadDeliveries(1);
        }
        
        // Enhanced driver and vehicle sections
        async function loadDrivers() {
            try {
                const response = await fetch(`${API_BASE}/drivers`);
                const data = await response.json();
                
                allDrivers = data.items || [];
                
                // Update stats
                document.getElementById('total-drivers').textContent = allDrivers.length;
                document.getElementById('available-drivers-count').textContent = allDrivers.filter(d => d.is_available).length;
                document.getElementById('busy-drivers').textContent = allDrivers.filter(d => !d.is_available).length;
                
                // Calculate today's completed
                let todayCompleted = 0;
                allDrivers.forEach(driver => {
                    if (driver.deliveries_today && driver.deliveries_today > 0) {
                        todayCompleted += driver.deliveries_today;
                    }
                });
                document.getElementById('today-completed-drivers').textContent = todayCompleted;
                
                // Render table
                const tbody = document.getElementById('drivers-tbody');
                tbody.innerHTML = '';
                
                allDrivers.forEach(driver => {
                    const row = `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${driver.employee_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium">${driver.name}</div>
                                ${driver.license_expiry_date ? `
                                    <div class="text-xs text-gray-500">
                                        駕照到期: ${formatDate(driver.license_expiry_date)}
                                    </div>
                                ` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${driver.phone}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${driver.license_type}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${driver.is_available ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${driver.is_available ? '可用' : '忙碌'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div>${driver.deliveries_today || 0} 筆</div>
                                ${driver.deliveries_this_month ? `
                                    <div class="text-xs text-gray-500">本月: ${driver.deliveries_this_month} 筆</div>
                                ` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="viewDriverDetails(${driver.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="詳細資料">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button onclick="toggleDriverAvailability(${driver.id})" class="text-purple-600 hover:text-purple-900 mr-2" title="切換狀態">
                                    <i class="fas fa-${driver.is_available ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="viewDriverDeliveries(${driver.id})" class="text-green-600 hover:text-green-900" title="配送記錄">
                                    <i class="fas fa-list"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                // Update delivery driver select
                const driverSelect = document.getElementById('delivery-driver');
                driverSelect.innerHTML = '<option value="">所有司機</option>';
                allDrivers.forEach(driver => {
                    driverSelect.innerHTML += `<option value="${driver.id}">${driver.name} ${driver.is_available ? '(可用)' : '(忙碌)'}</option>`;
                });
            } catch (error) {
                console.error('Error loading drivers:', error);
                showNotification('載入司機資料失敗', 'error');
            }
        }
        
        async function loadVehicles() {
            try {
                const response = await fetch(`${API_BASE}/vehicles`);
                const data = await response.json();
                
                allVehicles = data.items || [];
                
                // Update stats
                document.getElementById('total-vehicles').textContent = allVehicles.length;
                document.getElementById('available-vehicles-count').textContent = allVehicles.filter(v => v.is_active).length;
                document.getElementById('maintenance-vehicles').textContent = allVehicles.filter(v => !v.is_active).length;
                
                // Check maintenance due
                const today = new Date();
                let dueMaintenance = 0;
                allVehicles.forEach(vehicle => {
                    if (vehicle.next_maintenance_date) {
                        const maintenanceDate = new Date(vehicle.next_maintenance_date);
                        if (maintenanceDate <= today) {
                            dueMaintenance++;
                        }
                    }
                });
                document.getElementById('due-maintenance').textContent = dueMaintenance;
                
                // Render table
                const tbody = document.getElementById('vehicles-tbody');
                tbody.innerHTML = '';
                
                allVehicles.forEach(vehicle => {
                    const vehicleTypeMap = {
                        'truck': { text: '貨車', icon: 'truck' },
                        'van': { text: '廂型車', icon: 'shuttle-van' },
                        'motorcycle': { text: '機車', icon: 'motorcycle' }
                    };
                    
                    const type = vehicleTypeMap[vehicle.vehicle_type] || { text: vehicle.vehicle_type, icon: 'car' };
                    
                    // Check if maintenance is due
                    let maintenanceClass = '';
                    if (vehicle.next_maintenance_date) {
                        const maintenanceDate = new Date(vehicle.next_maintenance_date);
                        const daysUntil = Math.floor((maintenanceDate - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= 0) {
                            maintenanceClass = 'text-red-600 font-bold';
                        } else if (daysUntil <= 7) {
                            maintenanceClass = 'text-orange-600';
                        }
                    }
                    
                    const row = `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <i class="fas fa-${type.icon} text-gray-400 mr-2"></i>
                                    <span class="font-medium">${vehicle.plate_number}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${type.text}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${vehicle.brand} ${vehicle.model}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div>${vehicle.max_load_kg} kg</div>
                                <div class="text-xs text-gray-500">${vehicle.max_cylinders} 桶</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full ${vehicle.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${vehicle.is_active ? '可用' : '維修中'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${maintenanceClass}">
                                ${vehicle.next_maintenance_date ? formatDate(vehicle.next_maintenance_date) : '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="viewVehicleDetails(${vehicle.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="詳細資料">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button onclick="editVehicle(${vehicle.id})" class="text-green-600 hover:text-green-900 mr-2" title="編輯">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleVehicleStatus(${vehicle.id})" class="text-orange-600 hover:text-orange-900" title="維修狀態">
                                    <i class="fas fa-tools"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showNotification('載入車輛資料失敗', 'error');
            }
        }
        
        // Enhanced vehicle and driver detail functions
        async function viewDriverDetails(driverId) {
            try {
                const response = await fetch(`${API_BASE}/drivers/${driverId}`);
                const driver = await response.json();
                
                const modalContent = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">員工編號</p>
                            <p class="font-medium">${driver.employee_id}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">姓名</p>
                            <p class="font-medium">${driver.name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">電話</p>
                            <p class="font-medium">${driver.phone}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">身分證字號</p>
                            <p class="font-medium">${driver.id_number}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">地址</p>
                            <p class="font-medium">${driver.address}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">緊急聯絡人</p>
                            <p class="font-medium">${driver.emergency_contact}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">緊急聯絡電話</p>
                            <p class="font-medium">${driver.emergency_phone}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">駕照類型</p>
                            <p class="font-medium">${driver.license_type}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">駕照到期日</p>
                            <p class="font-medium ${new Date(driver.license_expiry_date) <= new Date() ? 'text-red-600' : ''}">${formatDate(driver.license_expiry_date)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">入職日期</p>
                            <p class="font-medium">${formatDate(driver.hire_date)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">底薪</p>
                            <p class="font-medium">$${driver.base_salary?.toLocaleString()}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">獎金比例</p>
                            <p class="font-medium">${driver.commission_rate}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">狀態</p>
                            <p class="font-medium">
                                <span class="px-2 py-1 text-xs rounded-full ${driver.is_available ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${driver.is_available ? '可用' : '忙碌'}
                                </span>
                            </p>
                        </div>
                        <div class="col-span-2 border-t pt-4">
                            <h4 class="font-semibold mb-2">配送統計</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">今日配送</p>
                                    <p class="font-medium">${driver.deliveries_today || 0} 筆</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">本月配送</p>
                                    <p class="font-medium">${driver.deliveries_this_month || 0} 筆</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">總配送數</p>
                                    <p class="font-medium">${driver.total_deliveries || 0} 筆</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('司機詳細資料', modalContent);
            } catch (error) {
                showNotification('載入司機資料失敗', 'error');
            }
        }
        
        async function viewVehicleDetails(vehicleId) {
            try {
                const response = await fetch(`${API_BASE}/vehicles/${vehicleId}`);
                const vehicle = await response.json();
                
                const vehicleTypeMap = {
                    'truck': '貨車',
                    'van': '廂型車',
                    'motorcycle': '機車'
                };
                
                const fuelTypeMap = {
                    'gasoline': '汽油',
                    'diesel': '柴油',
                    'electric': '電動',
                    'hybrid': '油電混合'
                };
                
                const modalContent = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">車牌號碼</p>
                            <p class="font-medium text-lg">${vehicle.plate_number}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">車型</p>
                            <p class="font-medium">${vehicleTypeMap[vehicle.vehicle_type] || vehicle.vehicle_type}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">品牌</p>
                            <p class="font-medium">${vehicle.brand}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">型號</p>
                            <p class="font-medium">${vehicle.model}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">出廠年份</p>
                            <p class="font-medium">${vehicle.year}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">燃料類型</p>
                            <p class="font-medium">${fuelTypeMap[vehicle.fuel_type] || vehicle.fuel_type}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">引擎號碼</p>
                            <p class="font-medium">${vehicle.engine_number}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">車身號碼</p>
                            <p class="font-medium">${vehicle.vin}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">顏色</p>
                            <p class="font-medium">${vehicle.color}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">掛牌日期</p>
                            <p class="font-medium">${formatDate(vehicle.registration_date)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">最大載重</p>
                            <p class="font-medium">${vehicle.max_load_kg} kg</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">最大瓦斯桶數</p>
                            <p class="font-medium">${vehicle.max_cylinders} 桶</p>
                        </div>
                        <div class="col-span-2 border-t pt-4">
                            <h4 class="font-semibold mb-2">維護資訊</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">保險到期日</p>
                                    <p class="font-medium ${new Date(vehicle.insurance_expiry_date) <= new Date() ? 'text-red-600' : ''}">${formatDate(vehicle.insurance_expiry_date)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">驗車到期日</p>
                                    <p class="font-medium ${new Date(vehicle.inspection_due_date) <= new Date() ? 'text-red-600' : ''}">${formatDate(vehicle.inspection_due_date)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">下次保養日期</p>
                                    <p class="font-medium ${vehicle.next_maintenance_date && new Date(vehicle.next_maintenance_date) <= new Date() ? 'text-red-600' : ''}">${vehicle.next_maintenance_date ? formatDate(vehicle.next_maintenance_date) : '-'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 border-t pt-4">
                            <h4 class="font-semibold mb-2">里程與油耗</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">當前里程</p>
                                    <p class="font-medium">${vehicle.current_mileage?.toLocaleString() || 0} km</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">平均油耗</p>
                                    <p class="font-medium">${vehicle.fuel_efficiency || '-'} km/L</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-span-2 border-t pt-4">
                            <h4 class="font-semibold mb-2">購買資訊</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">購買日期</p>
                                    <p class="font-medium">${formatDate(vehicle.purchase_date)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">購買價格</p>
                                    <p class="font-medium">$${vehicle.purchase_price?.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        ${vehicle.assigned_driver_name ? `
                        <div class="col-span-2 border-t pt-4">
                            <p class="text-sm text-gray-600">指派司機</p>
                            <p class="font-medium">${vehicle.assigned_driver_name}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                showModal('車輛詳細資料', modalContent);
            } catch (error) {
                showNotification('載入車輛資料失敗', 'error');
            }
        }
    </script>
    
    <!-- Route Planning Modal -->
    <div id="routePlanModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">自動路線規劃</h3>
            <form id="route-plan-form">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">配送日期 *</label>
                        <input type="date" name="delivery_date" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">區域（選填）</label>
                        <select name="area" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">不限區域</option>
                            <option value="A-瑞光">A-瑞光</option>
                            <option value="B-四維">B-四維</option>
                            <option value="C-復國">C-復國</option>
                            <option value="D-泰東">D-泰東</option>
                            <option value="E-寶桑">E-寶桑</option>
                            <option value="F-成功線">F-成功線</option>
                            <option value="G-南迴線">G-南迴線</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">優化目標</label>
                        <select name="optimize_by" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="distance">最短距離</option>
                            <option value="time">最短時間</option>
                            <option value="balanced">平衡模式</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始時間</label>
                        <input type="time" name="start_time" value="08:00" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束時間</label>
                        <input type="time" name="end_time" value="18:00" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大行駛距離 (km)</label>
                        <input type="number" name="max_distance_km" min="0" step="0.1" placeholder="不限" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大工作時間 (分鐘)</label>
                        <input type="number" name="max_duration_minutes" min="0" placeholder="不限" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">可用司機</label>
                        <div class="border rounded p-2 max-h-32 overflow-y-auto" id="route-plan-drivers">
                            <!-- Driver checkboxes will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">可用車輛</label>
                        <div class="border rounded p-2 max-h-32 overflow-y-auto" id="route-plan-vehicles">
                            <!-- Vehicle checkboxes will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="use_traffic" class="mr-2">
                            <span class="text-sm">考慮即時路況</span>
                        </label>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="include_break_time" checked class="mr-2">
                            <span class="text-sm">包含休息時間</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal('routePlanModal')" class="px-4 py-2 border rounded hover:bg-gray-100 transition">
                        取消
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        開始規劃
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Route Details Modal -->
    <div id="routeDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">路線詳情</h3>
                <button onclick="closeModal('routeDetailsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="route-details-content">
                <!-- Route details will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Manual Route Creation Modal -->
    <div id="addRouteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">手動建立路線</h3>
            <form id="add-route-form">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">路線日期 *</label>
                        <input type="date" name="route_date" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">路線名稱 *</label>
                        <input type="text" name="route_name" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500" placeholder="例：A區-上午路線">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">區域 *</label>
                        <select name="area" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇區域</option>
                            <option value="A-瑞光">A-瑞光</option>
                            <option value="B-四維">B-四維</option>
                            <option value="C-復國">C-復國</option>
                            <option value="D-泰東">D-泰東</option>
                            <option value="E-寶桑">E-寶桑</option>
                            <option value="F-成功線">F-成功線</option>
                            <option value="G-南迴線">G-南迴線</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">司機 *</label>
                        <select name="driver_id" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇司機</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">車輛 *</label>
                        <select name="vehicle_id" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                            <option value="">請選擇車輛</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">選擇客戶 *</label>
                    <div class="border rounded p-4">
                        <input type="text" placeholder="搜尋客戶..." class="w-full px-3 py-2 border rounded mb-4" id="route-client-search">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium mb-2">可選客戶</h4>
                                <div class="border rounded p-2 h-64 overflow-y-auto" id="available-clients">
                                    <!-- Available clients will be listed here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium mb-2">已選客戶 (<span id="selected-clients-count">0</span>)</h4>
                                <div class="border rounded p-2 h-64 overflow-y-auto" id="selected-clients">
                                    <!-- Selected clients will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeModal('addRouteModal')" class="px-4 py-2 border rounded hover:bg-gray-100 transition">
                        取消
                    </button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        建立路線
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Advanced Scheduling Modal -->
    <div id="schedulingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">進階排程系統</h3>
                <button onclick="closeModal('schedulingModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="scheduling-form">
                <!-- Date Selection Section -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">排程日期範圍</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">排程類型</label>
                            <select name="schedule_type" id="schedule-type" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500" onchange="toggleDateRangeInputs()">
                                <option value="single">單日排程</option>
                                <option value="range">日期範圍排程</option>
                            </select>
                        </div>
                        <div id="single-date-input">
                            <label class="block text-sm font-medium text-gray-700 mb-2">排程日期</label>
                            <input type="date" name="schedule_date" id="schedule-date" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                        </div>
                        <div id="date-range-inputs" class="hidden col-span-2">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                                    <input type="date" name="start_date" id="start-date" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                                    <input type="date" name="end_date" id="end-date" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Algorithm Selection -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">演算法設定</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">排程演算法</label>
                            <select name="algorithm" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500" onchange="updateAlgorithmDescription()">
                                <option value="greedy">貪婪演算法 (快速)</option>
                                <option value="genetic">基因演算法 (最佳化)</option>
                                <option value="simulated_annealing">模擬退火 (平衡)</option>
                            </select>
                            <p id="algorithm-description" class="text-sm text-gray-600 mt-1">快速找到可行解，適合日常排程</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">最大計算時間 (秒)</label>
                            <input type="number" name="time_limit_seconds" value="30" min="5" max="300" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Optimization Objectives -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">優化目標</h4>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="objectives" value="minimize_distance" checked class="mr-2">
                            <span>最小化總行駛距離</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="objectives" value="maximize_time_compliance" checked class="mr-2">
                            <span>最大化時間窗口符合度</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="objectives" value="balance_workload" class="mr-2">
                            <span>平衡司機工作量</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="objectives" value="minimize_overtime" class="mr-2">
                            <span>最小化加班時間</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="objectives" value="maximize_utilization" class="mr-2">
                            <span>最大化車輛使用率</span>
                        </label>
                    </div>
                </div>
                
                <!-- Constraints -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">約束條件</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">最大配送/路線</label>
                            <input type="number" name="max_deliveries_per_route" value="20" min="5" max="50" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">最小配送/路線</label>
                            <input type="number" name="min_deliveries_per_route" value="5" min="1" max="20" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">平均行駛速度 (km/h)</label>
                            <input type="number" name="travel_speed_kmh" value="30" min="10" max="60" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="allow_overtime" class="mr-2">
                            <span>允許加班</span>
                        </label>
                    </div>
                </div>
                
                <!-- Resource Selection -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">資源選擇（選填）</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">指定司機</label>
                            <select name="driver_ids" multiple class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500" size="5">
                                <!-- Options will be populated dynamically -->
                            </select>
                            <p class="text-sm text-gray-600 mt-1">按住 Ctrl/Cmd 多選，留空表示使用所有可用司機</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">指定車輛</label>
                            <select name="vehicle_ids" multiple class="w-full px-3 py-2 border rounded focus:outline-none focus:border-blue-500" size="5">
                                <!-- Options will be populated dynamically -->
                            </select>
                            <p class="text-sm text-gray-600 mt-1">按住 Ctrl/Cmd 多選，留空表示使用所有可用車輛</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('schedulingModal')" class="px-4 py-2 border rounded hover:bg-gray-100 transition">
                        取消
                    </button>
                    <button type="button" onclick="previewSchedule()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        <i class="fas fa-eye mr-2"></i>預覽排程
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-magic mr-2"></i>生成排程
                    </button>
                </div>
            </form>
            
            <!-- Results Section (Initially Hidden) -->
            <div id="scheduling-results" class="hidden mt-6 border-t pt-6">
                <h4 class="font-semibold mb-3">排程結果</h4>
                <div id="scheduling-results-content">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>