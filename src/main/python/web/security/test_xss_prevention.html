<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Prevention Testing</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-passed { background-color: #d1fae5; }
        .test-failed { background-color: #fee2e2; }
        .xss-payload { font-family: monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">XSS Prevention Testing Suite</h1>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="flex gap-4">
                <button onclick="runAllTests()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-play mr-2"></i>Run All Tests
                </button>
                <button onclick="clearResults()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    <i class="fas fa-trash mr-2"></i>Clear Results
                </button>
            </div>
        </div>
        
        <!-- XSS Payloads -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">XSS Test Payloads</h2>
            <div id="payloads-list" class="space-y-2"></div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="test-summary" class="mb-4 p-4 bg-gray-50 rounded"></div>
            <div id="test-results" class="space-y-4"></div>
        </div>
        
        <!-- Live Testing Areas -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Live Testing Areas</h2>
            
            <!-- Vulnerable Implementation -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Vulnerable Implementation (innerHTML)
                </h3>
                <div id="vulnerable-area" class="border border-red-300 rounded p-4 bg-red-50"></div>
            </div>
            
            <!-- Secure Implementation -->
            <div>
                <h3 class="text-lg font-semibold mb-2 text-green-600">
                    <i class="fas fa-shield-alt mr-2"></i>Secure Implementation (SecurityUtils)
                </h3>
                <div id="secure-area" class="border border-green-300 rounded p-4 bg-green-50"></div>
            </div>
        </div>
        
        <!-- Client Table Test -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Client Table Rendering Test</h2>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-red-600">Vulnerable Table</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody id="vulnerable-table-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-green-600">Secure Table</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody id="secure-table-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Select Dropdown Test -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Select Dropdown Test</h2>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-red-600">Vulnerable Select</h3>
                    <select id="vulnerable-select" class="w-full p-2 border rounded"></select>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-green-600">Secure Select</h3>
                    <select id="secure-select" class="w-full p-2 border rounded"></select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Load Security Utils -->
    <script src="security-utils.js"></script>
    <script src="xss_migration_examples.js"></script>
    
    <script>
        // XSS Test Payloads
        const xssPayloads = [
            {
                name: 'Basic Script Tag',
                payload: '<script>alert("XSS")</script>',
                description: 'Simple script injection'
            },
            {
                name: 'IMG Tag with onerror',
                payload: '<img src=x onerror=alert("XSS")>',
                description: 'Image error handler injection'
            },
            {
                name: 'JavaScript Protocol',
                payload: 'javascript:alert("XSS")',
                description: 'JavaScript protocol in URLs'
            },
            {
                name: 'SVG onload',
                payload: '<svg onload=alert("XSS")>',
                description: 'SVG element with event handler'
            },
            {
                name: 'Attribute Breaking',
                payload: '"><script>alert("XSS")</script>',
                description: 'Breaking out of attributes'
            },
            {
                name: 'Event Handler',
                payload: '" onclick="alert(\'XSS\')" data-dummy="',
                description: 'Injecting event handlers'
            },
            {
                name: 'Unicode Encoding',
                payload: '\u003cscript\u003ealert("XSS")\u003c/script\u003e',
                description: 'Unicode encoded script'
            },
            {
                name: 'HTML Entity Encoding',
                payload: '&lt;script&gt;alert("XSS")&lt;/script&gt;',
                description: 'HTML entity encoded script'
            }
        ];
        
        // Test client data with XSS payloads
        const testClients = [
            {
                id: 1,
                client_code: 'C001',
                name: '<script>alert("XSS in name")</script>',
                phone: '"><script>alert("XSS in phone")</script>',
                address: '<img src=x onerror=alert("XSS-in-address")>',
                district: 'javascript:alert("XSS")',
                area: '<svg onload=alert("XSS")>'
            },
            {
                id: 2,
                client_code: '"><script>alert("XSS")</script>',
                name: 'Normal Client Name',
                phone: '0912-345-678',
                address: '123 Main St',
                district: 'Central',
                area: 'Downtown'
            }
        ];
        
        // Initialize payloads display
        function displayPayloads() {
            const container = document.getElementById('payloads-list');
            container.innerHTML = '';
            
            xssPayloads.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                div.innerHTML = `
                    <div>
                        <strong>${item.name}:</strong>
                        <span class="xss-payload">${escapeHtml(item.payload)}</span>
                        <span class="text-sm text-gray-600 ml-2">${item.description}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Helper to escape HTML for display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Run all tests
        async function runAllTests() {
            const results = [];
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '';
            
            // Test 1: Basic escaping
            results.push(testBasicEscaping());
            
            // Test 2: Element creation
            results.push(testElementCreation());
            
            // Test 3: Table rendering
            results.push(testTableRendering());
            
            // Test 4: Select population
            results.push(testSelectPopulation());
            
            // Test 5: Live area testing
            results.push(testLiveAreas());
            
            // Display summary
            displayTestSummary(results);
            
            // Display individual results
            results.forEach(result => {
                displayTestResult(result);
            });
        }
        
        // Test basic HTML escaping
        function testBasicEscaping() {
            const testName = 'Basic HTML Escaping';
            const subTests = [];
            
            xssPayloads.forEach(item => {
                const escaped = SecurityUtils.escapeHtml(item.payload);
                const isScript = escaped.includes('<script');
                const isHandler = escaped.includes('onerror=') || escaped.includes('onload=');
                const isJavascript = escaped.includes('javascript:');
                
                subTests.push({
                    name: item.name,
                    passed: !isScript && !isHandler && !isJavascript,
                    input: item.payload,
                    output: escaped
                });
            });
            
            return {
                name: testName,
                passed: subTests.every(t => t.passed),
                subTests: subTests
            };
        }
        
        // Test element creation
        function testElementCreation() {
            const testName = 'Safe Element Creation';
            const subTests = [];
            
            xssPayloads.forEach(item => {
                const element = SecurityUtils.createElement('div', {}, [item.payload]);
                const html = element.innerHTML;
                const text = element.textContent;
                
                subTests.push({
                    name: item.name,
                    passed: text === item.payload && !html.includes('<script'),
                    input: item.payload,
                    output: html
                });
            });
            
            return {
                name: testName,
                passed: subTests.every(t => t.passed),
                subTests: subTests
            };
        }
        
        // Test table rendering
        function testTableRendering() {
            const testName = 'Table Rendering Security';
            
            // Render vulnerable table
            const vulnerableBody = document.getElementById('vulnerable-table-tbody');
            try {
                XSSMigrationExamples.renderClientsTable_VULNERABLE.call(null, testClients);
            } catch (e) {
                // Expected to potentially fail with XSS
            }
            
            // Render secure table
            const secureBody = document.getElementById('secure-table-tbody');
            const secureClients = testClients; // Use same data
            
            // Manually render secure version since we don't have the actual function
            secureBody.innerHTML = '';
            secureClients.forEach(client => {
                const row = SecurityUtils.createTableRow([
                    SecurityUtils.escapeHtml(client.client_code),
                    SecurityUtils.escapeHtml(client.name),
                    SecurityUtils.escapeHtml(client.phone),
                    SecurityUtils.escapeHtml(client.address)
                ], 'hover:bg-gray-50');
                secureBody.appendChild(row);
            });
            
            return {
                name: testName,
                passed: !secureBody.innerHTML.includes('<script'),
                subTests: [{
                    name: 'Secure table rendering',
                    passed: !secureBody.innerHTML.includes('<script'),
                    input: 'Test client data with XSS',
                    output: 'Rendered safely'
                }]
            };
        }
        
        // Test select population
        function testSelectPopulation() {
            const testName = 'Select Dropdown Security';
            
            const options = [
                { value: '', text: 'Select an option' },
                { value: '<script>alert("XSS")</script>', text: '<script>alert("XSS")</script>' },
                { value: 'normal', text: 'Normal Option' }
            ];
            
            // Vulnerable approach
            const vulnerableSelect = document.getElementById('vulnerable-select');
            vulnerableSelect.innerHTML = options.map(opt => 
                `<option value="${opt.value}">${opt.text}</option>`
            ).join('');
            
            // Secure approach
            const secureSelect = document.getElementById('secure-select');
            SecurityUtils.populateSelect(secureSelect, options);
            
            return {
                name: testName,
                passed: !secureSelect.innerHTML.includes('<script>'),
                subTests: [{
                    name: 'Secure select population',
                    passed: !secureSelect.innerHTML.includes('<script>'),
                    input: 'Options with XSS payloads',
                    output: 'Rendered safely'
                }]
            };
        }
        
        // Test live areas
        function testLiveAreas() {
            const testName = 'Live Area Injection Test';
            const payload = '<img src=x onerror=alert("XSS-Test")> Normal Text';
            
            // Vulnerable area
            const vulnerableArea = document.getElementById('vulnerable-area');
            vulnerableArea.innerHTML = `User input: ${payload}`;
            
            // Secure area
            const secureArea = document.getElementById('secure-area');
            SecurityUtils.renderTemplate(secureArea, [
                'User input: ',
                SecurityUtils.escapeHtml(payload)
            ]);
            
            return {
                name: testName,
                passed: !secureArea.innerHTML.includes('<img'),
                subTests: [{
                    name: 'Live content injection',
                    passed: !secureArea.innerHTML.includes('<img'),
                    input: payload,
                    output: secureArea.textContent
                }]
            };
        }
        
        // Display test summary
        function displayTestSummary(results) {
            const summary = document.getElementById('test-summary');
            const total = results.length;
            const passed = results.filter(r => r.passed).length;
            const failed = total - passed;
            
            summary.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <strong>Test Summary:</strong>
                        <span class="ml-4">Total: ${total}</span>
                        <span class="ml-4 text-green-600">Passed: ${passed}</span>
                        <span class="ml-4 text-red-600">Failed: ${failed}</span>
                    </div>
                    <div>
                        ${passed === total ? 
                            '<span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-2"></i>All Tests Passed!</span>' : 
                            '<span class="text-red-600 font-semibold"><i class="fas fa-exclamation-circle mr-2"></i>Some Tests Failed</span>'
                        }
                    </div>
                </div>
            `;
        }
        
        // Display individual test result
        function displayTestResult(result) {
            const container = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `border rounded p-4 ${result.passed ? 'test-passed border-green-300' : 'test-failed border-red-300'}`;
            
            let html = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold">${result.name}</h3>
                    <span class="${result.passed ? 'text-green-600' : 'text-red-600'}">
                        <i class="fas fa-${result.passed ? 'check' : 'times'}-circle"></i>
                        ${result.passed ? 'Passed' : 'Failed'}
                    </span>
                </div>
            `;
            
            if (result.subTests && result.subTests.length > 0) {
                html += '<div class="space-y-2 mt-4">';
                result.subTests.forEach(subTest => {
                    html += `
                        <div class="pl-4 border-l-2 ${subTest.passed ? 'border-green-400' : 'border-red-400'}">
                            <div class="flex justify-between items-start">
                                <span class="font-medium">${subTest.name}</span>
                                <span class="${subTest.passed ? 'text-green-600' : 'text-red-600'} text-sm">
                                    ${subTest.passed ? 'Safe' : 'Vulnerable'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                <div>Input: <span class="xss-payload">${escapeHtml(subTest.input)}</span></div>
                                <div>Output: <span class="xss-payload">${escapeHtml(subTest.output)}</span></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            div.innerHTML = html;
            container.appendChild(div);
        }
        
        // Clear results
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
            document.getElementById('vulnerable-area').innerHTML = '';
            document.getElementById('secure-area').innerHTML = '';
            document.getElementById('vulnerable-table-tbody').innerHTML = '';
            document.getElementById('secure-table-tbody').innerHTML = '';
            document.getElementById('vulnerable-select').innerHTML = '';
            document.getElementById('secure-select').innerHTML = '';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            displayPayloads();
        });
    </script>
</body>
</html>